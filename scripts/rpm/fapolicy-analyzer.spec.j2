# Copyright Concurrent Technologies Corporation 2021
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

%global git_commit {{ git_commit }}
%global app_version {{ app_version }}

Name:           fapolicy-analyzer
Version:        {{ rpm_version }}
Release:        {{ rpm_release }}%{?dist}
Summary:        GUI configuration for fapolicyd
License:        GPLv3+
URL:            https://github.com/ctc-oss/fapolicy-analyzer

Source0: %{url}/archive/%{git_commit}/%{name}-%{git_commit}.tar.gz

BuildArch:      x86_64
Requires:       {{ pyrpm }} >= 3.9
BuildRequires:  {{ pyrpm }} >= 3.9, {{ pyrpm }}-rpm-macros, {{ pyrpm }}-devel, {{ pyrpm }}-pip, {{ pyrpm }}-wheel
Recommends:     {{ pyrpm }}-gobject, {{ pyrpm }}-events, {{ pyrpm }}-configargparse, {{ pyrpm }}-more-itertools, {{ pyrpm }}-rx
Requires:       gtk3, dbus-libs, gtksourceview3
BuildRequires:  dbus-devel, cargo
AutoReqProv:    no

# For tools not packaged in el8, just use pip always.
%prep
%autosetup -n %{name}-%(echo %{git_commit} | sed -e 's/^v//')
%{python3} -m pip install --no-input Babel setuptools-rust

%description
GUI and CLI tools to assist with the configuration and maintenance of fapolicyd

%global debug_package %{nil}

%build
VERSION=%{app_version} %{python3} setup.py compile_catalog -f
VERSION=%{app_version} %{python3} setup.py bdist_wheel

%install
%{python3} -m pip install --no-deps --no-input -v --target %{buildroot}%{python3_sitelib} dist/*.whl
%{python3} -m pip install --no-deps --no-input -v --target %{buildroot}%{python3_sitelib} vendor/ReduxPY
install bin/fapolicy-analyzer %{buildroot}%{_sbindir}/fapolicy-analyzer -D
install share/sourceview/language-specs/fapolicyd-rules.lang %{buildroot}%{_datadir}/gtksourceview-3.0/language-specs/fapolicyd-rules.lang -D

%files
%{python3_sitelib}/fapolicy_analyzer*
%{python3_sitelib}/redux*
%{_sbindir}/fapolicy-analyzer
%{_datadir}/gtksourceview-3.0/*

%defattr(-,root,root)

%changelog
* Wed Jul 28 2021 CTC OSS <oss@ctc.com> 0.0-0
- GitHub Release RPM
